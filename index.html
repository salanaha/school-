<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <style>
        :root {
            --primary-color: #006233;
            --secondary-color: #2E7D32;
            --danger-color: #D32F2F;
            --warning-color: #FF9800;
            --info-color: #1976D2;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-2px);
        }
        
        .card-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #004d26;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 98, 51, 0.3);
        }
        
        .btn-secondary {
            background: var(--info-color);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
            min-width: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 98, 51, 0.1);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group .form-control {
            flex: 1;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: 600;
            text-align: center;
            border: none;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
            transition: background 0.2s;
        }
        
        tr:hover td {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border-top: 4px solid var(--primary-color);
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .nav-tab.active {
            background: var(--primary-color);
            color: white;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        ğŸ“˜ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="card">
            <div class="card-title">
                <span>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span>
            </div>
            
            <div id="loginAlert" class="alert hidden"></div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" id="email" class="form-control" placeholder="example@school.edu">
            </div>
            
            <div class="form-group">
                <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="password" class="form-control" placeholder="******">
            </div>
            
            <div class="form-group">
                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                <select id="roleSelect" class="form-control">
                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                    <option value="admin">ğŸ‘‘ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</option>
                    <option value="advisor">ğŸ“ Ù…Ø³ØªØ´Ø§Ø± ØªØ±Ø¨ÙˆÙŠ</option>
                    <option value="teacher">ğŸ‘¨â€ğŸ« Ø£Ø³ØªØ§Ø°</option>
                </select>
            </div>
            
            <div class="input-group">
                <button class="btn btn-primary" onclick="register()" style="flex: 1;">
                    ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                </button>
                <button class="btn btn-secondary" onclick="login()" style="flex: 1;">
                    ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 20px; color: #666;">
                <small>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù…ÙŠØ© ÙˆÙ…Ø´ÙØ±Ø© ÙˆÙÙ‚ Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù†</small>
            </div>
        </div>

        <!-- School Info Section -->
        <div id="schoolInfoSection" class="card hidden">
            <div class="card-title">
                <span>ğŸ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</span>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
                <input type="text" id="schoolName" class="form-control" placeholder="Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©">
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
                <input type="text" id="schoolCode" class="form-control" placeholder="123456">
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label>
                <select id="province" class="form-control">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</option>
                    <option>Ø£Ø¯Ø±Ø§Ø±</option><option>Ø§Ù„Ø´Ù„Ù</option><option>Ø§Ù„Ø£ØºÙˆØ§Ø·</option>
                    <option>Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ</option><option>Ø¨Ø§ØªÙ†Ø©</option><option>Ø¨Ø¬Ø§ÙŠØ©</option>
                    <option>Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</option><option>Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©</option>
                    <option>ÙˆÙ‡Ø±Ø§Ù†</option><option>Ø³Ø·ÙŠÙ</option><option>Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©</option>
                    <option>Ø¹Ù†Ø§Ø¨Ø©</option><option>ØºØ±Ø¯Ø§ÙŠØ©</option><option>Ù…Ø³ÙŠÙ„Ø©</option>
                    <option>Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³</option><option>ØªÙŠØ¨Ø§Ø²Ø©</option><option>Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©</option>
                    <option>Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³</option><option>ØªÙ„Ù…Ø³Ø§Ù†</option><option>ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ</option>
                    <option>Ø¨Ø³ÙƒØ±Ø©</option><option>Ø§Ù„Ø¬Ù„ÙØ©</option><option>Ø³Ø·ÙŠÙ</option>
                </select>
            </div>
            
            <button class="btn btn-primary" onclick="saveSchool()" style="width: 100%;">
                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
            </button>
        </div>

        <!-- Upload Section -->
        <div id="uploadSection" class="card hidden">
            <div class="card-title">
                <span>ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</span>
            </div>
            
            <div class="alert alert-success">
                <span>âš ï¸ Ù…Ù‡Ù…:</span> ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨ØµÙŠØºØ© Excel (xlsx) ÙˆØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØµØ­ÙŠØ­Ø©
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    ğŸ‘¨â€ğŸ“ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°
                    <small style="color: #666;">(ÙŠØ¬Ø¨ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: Ø§Ù„Ù„Ù‚Ø¨ØŒ Ø§Ù„Ø¥Ø³Ù…ØŒ Ø§Ù„Ù‚Ø³Ù…ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</small>
                </label>
                <input type="file" id="studentsFile" class="form-control" accept=".xlsx,.xls">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    ğŸ‘¨â€ğŸ« Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
                    <small style="color: #666;">(ÙŠØ¬Ø¨ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: Ø§Ù„Ø¥Ø³Ù…ØŒ Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ)</small>
                </label>
                <input type="file" id="teachersFile" class="form-control" accept=".xlsx,.xls">
            </div>
            
            <div class="input-group">
                <button class="btn btn-primary" onclick="loadFiles()" style="flex: 1;">
                    ğŸ“Š Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <button class="btn btn-secondary" onclick="downloadTemplate()" style="flex: 1;">
                    ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆØ§Ù„Ø¨ Ø¬Ø§Ù‡Ø²Ø©
                </button>
            </div>
            
            <div id="uploadProgress" class="hidden">
                <div style="background: #f0f0f0; border-radius: 10px; height: 10px; margin-top: 20px;">
                    <div id="progressBar" style="background: var(--primary-color); height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s;"></div>
                </div>
                <div style="text-align: center; margin-top: 10px; color: #666;">
                    <span id="progressText">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>
                </div>
            </div>
        </div>

        <!-- Main System -->
        <div id="mainSystem" class="hidden">
            <!-- Navigation -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('dashboardSection')">
                    ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
                <button class="nav-tab" onclick="showSection('studentsSection')">
                    ğŸ‘¨â€ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°
                </button>
                <button class="nav-tab" onclick="showSection('teachersSection')">
                    ğŸ‘¨â€ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
                </button>
                <button class="nav-tab" onclick="showSection('attendanceSection')">
                    ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
                </button>
                <button class="nav-tab" onclick="showSection('reportsSection')">
                    ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                </button>
                <button id="adminTab" class="nav-tab hidden" onclick="showSection('adminSection')">
                    âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
                </button>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="card">
                <div class="card-title">
                    <span>ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</span>
                    <small style="margin-right: auto; color: #666;">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="userName"></span></small>
                </div>
                
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">ğŸ‘¨â€ğŸ“ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTeachers">0</div>
                        <div class="stat-label">ğŸ‘¨â€ğŸ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayAbsence">0</div>
                        <div class="stat-label">ğŸ“ ØºÙŠØ§Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h4>
                        <canvas id="studentsChart" height="250"></canvas>
                    </div>
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">Ù†Ø³Ø¨Ø© Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h4>
                        <canvas id="attendanceChart" height="250"></canvas>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">ğŸ”” Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©</h4>
                    <div id="recentActivities" style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <div class="empty-state">
                            <span>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ø­Ø¯ÙŠØ«Ø©</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Section -->
            <div id="studentsSection" class="card hidden">
                <div class="card-title">
                    <span>ğŸ‘¨â€ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°</span>
                    <div style="margin-right: auto;">
                        <input type="text" id="studentSearch" class="form-control" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† ØªÙ„Ù…ÙŠØ°..." style="width: 250px;">
                    </div>
                </div>
                
                <div class="input-group" style="margin-bottom: 20px;">
                    <select id="classFilter" class="form-control" style="flex: 1;">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                    </select>
                    <button class="btn btn-primary" onclick="exportStudents()">
                        ğŸ“¥ ØªØµØ¯ÙŠØ± Excel
                    </button>
                    <button class="btn btn-secondary" onclick="showAddStudentModal()">
                        â• Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù…ÙŠØ° Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</th>
                                <th>Ø§Ù„Ù„Ù‚Ø¨</th>
                                <th>Ø§Ù„Ø¥Ø³Ù…</th>
                                <th>Ø§Ù„Ù‚Ø³Ù…</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th>
                                <th>Ù†Ø³Ø¨Ø© Ø§Ù„ØºÙŠØ§Ø¨</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <tr>
                                <td colspan="8">
                                    <div class="loading">
                                        <div class="loading-spinner"></div>
                                        <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <div>
                        Ø¹Ø±Ø¶ <select id="pageSize" onchange="loadStudents()" style="padding: 5px; border-radius: 5px;">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select> Ø³Ø¬Ù„Ø§Øª
                    </div>
                    <div>
                        <button class="btn btn-sm" onclick="changePage(-1)" id="prevPage">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                        <span style="margin: 0 10px;">ØµÙØ­Ø© <span id="currentPage">1</span></span>
                        <button class="btn btn-sm" onclick="changePage(1)" id="nextPage">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    </div>
                </div>
            </div>

            <!-- Teachers Section -->
            <div id="teachersSection" class="card hidden">
                <div class="card-title">
                    <span>ğŸ‘¨â€ğŸ« Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</span>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„Ø¥Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
                                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="teachersTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Attendance Section -->
            <div id="attendanceSection" class="card hidden">
                <div class="card-title">
                    <span>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="attendanceDate" class="form-control" value="">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</label>
                    <select id="attendanceClass" class="form-control">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
                    </select>
                </div>
                
                <div id="attendanceTableContainer"></div>
                
                <button class="btn btn-primary" onclick="saveAttendance()" style="width: 100%; margin-top: 20px;">
                    ğŸ’¾ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±
                </button>
            </div>

            <!-- Admin Section -->
            <div id="adminSection" class="card hidden">
                <div class="card-title">
                    <span>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                        <th>Ø§Ù„Ø¯ÙˆØ±</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div>
                        <h4>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: <strong id="userCount">0</strong></p>
                            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©: <strong id="sessionCount">0</strong></p>
                            <p>Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: <strong id="lastBackup">ØºÙŠØ± Ù…ØªÙˆÙØ±</strong></p>
                            <p>Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: <strong id="storageUsed">0 MB</strong></p>
                            
                            <button class="btn btn-primary" onclick="createBackup()" style="width: 100%; margin-top: 15px;">
                                ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="card hidden">
                <div class="card-title">
                    <span>ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
                </div>
                
                <div class="input-group">
                    <select id="reportType" class="form-control">
                        <option value="attendance">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨</option>
                        <option value="students">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°</option>
                        <option value="teachers">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</option>
                        <option value="monthly">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</option>
                    </select>
                    <input type="month" id="reportMonth" class="form-control">
                    <button class="btn btn-primary" onclick="generateReport()">
                        ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                    <button class="btn btn-secondary" onclick="printReport()">
                        ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                </div>
                
                <div id="reportOutput" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div style="text-align: center; padding: 20px; color: #666; margin-top: 40px;">
        <small>Â© 2024 Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ | Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</small>
        <br>
        <small>Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0 | ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ± Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</small>
    </div>

    <script>
        // ========== ØªÙ‡ÙŠØ¦Ø© Firebase (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø·) ==========
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠØ¬Ø¨ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Backend
        const firebaseConfig = {
            apiKey: "AIzaSyCVzCCaJG2c_Mns3d788NM6Ifj_QiyVkk8",
            authDomain: "education-algeria.firebaseapp.com",
            projectId: "education-algeria",
            storageBucket: "education-algeria.firebasestorage.app",
            messagingSenderId: "329772568704",
            appId: "1:329772568704:web:ad98730f6789bfd3469665"
        };

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        let app;
        try {
            app = firebase.initializeApp(firebaseConfig);
            console.log("âœ… Firebase initialized successfully");
        } catch (error) {
            console.error("âŒ Firebase initialization error:", error);
            // ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
            alert("âš ï¸ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±: Firebase ØºÙŠØ± Ù…Ù‡ÙŠØ¦ØŒ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„");
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
        let currentUser = null;
        let userRole = null;
        let currentSchool = null;
        let students = [];
        let teachers = [];
        let classes = [];
        let attendance = [];
        let currentPage = 1;
        let pageSize = 25;

        // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ==========
        async function register() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const role = document.getElementById('roleSelect').value;
            
            if (!validateEmail(email)) {
                showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­', 'danger');
                return;
            }
            
            if (!password || password.length < 6) {
                showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'danger');
                return;
            }
            
            if (!role) {
                showAlert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨', 'danger');
                return;
            }
            
            try {
                showLoading();
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
                await db.collection('users').doc(currentUser.uid).set({
                    email: email,
                    role: role,
                    approved: role === 'admin', // Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ø¹ØªÙ…Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showAlert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                await loginAfterRegister(email, password);
            } catch (error) {
                console.error('Registration error:', error);
                handleAuthError(error);
            }
        }

        async function loginAfterRegister(email, password) {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (!userDoc.exists) {
                    throw new Error('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                }
                
                const userData = userDoc.data();
                userRole = userData.role;
                
                // ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
                await db.collection('users').doc(currentUser.uid).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
                document.getElementById('loginSection').classList.add('hidden');
                
                if (userRole === 'admin') {
                    document.getElementById('schoolInfoSection').classList.remove('hidden');
                } else {
                    showAlert('â³ Ø­Ø³Ø§Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±', 'warning');
                }
                
            } catch (error) {
                console.error('Login after register error:', error);
                handleAuthError(error);
            }
        }

        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!email || !password) {
                showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'danger');
                return;
            }
            
            try {
                showLoading();
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (!userDoc.exists) {
                    throw new Error('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                }
                
                const userData = userDoc.data();
                userRole = userData.role;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙŠØ±Ø§Ù‹)
                if (!userData.approved && userRole !== 'admin') {
                    showAlert('â³ Ø­Ø³Ø§Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±', 'warning');
                    hideLoading();
                    return;
                }
                
                // ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
                await db.collection('users').doc(currentUser.uid).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
                document.getElementById('loginSection').classList.add('hidden');
                
                if (userRole === 'admin') {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ø³Ø¬Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
                    const schoolCheck = await checkIfSchoolExists();
                    
                    if (schoolCheck.exists) {
                        // Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù†Ø¸Ø§Ù…
                        currentSchool = schoolCheck.data;
                        await initializeSystem();
                    } else {
                        // Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                        document.getElementById('schoolInfoSection').classList.remove('hidden');
                    }
                } else {
                    // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†ØŒ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø£ÙˆÙ„Ø§Ù‹
                    if (userData.schoolCode) {
                        const schoolDoc = await db.collection('schools').doc(userData.schoolCode).get();
                        if (schoolDoc.exists) {
                            currentSchool = schoolDoc.data();
                            await initializeSystem();
                        }
                    }
                }
                
                showAlert(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! (${userRole})`, 'success');
            } catch (error) {
                console.error('Login error:', error);
                handleAuthError(error);
            } finally {
                hideLoading();
            }
        }

        async function checkIfSchoolExists() {
            try {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                if (userData && userData.schoolCode) {
                    const schoolDoc = await db.collection('schools').doc(userData.schoolCode).get();
                    return {
                        exists: schoolDoc.exists,
                        data: schoolDoc.exists ? schoolDoc.data() : null
                    };
                }
                
                return { exists: false, data: null };
            } catch (error) {
                console.error('Error checking school:', error);
                return { exists: false, data: null };
            }
        }

        function handleAuthError(error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', error);
            
            const messages = {
                'auth/email-already-in-use': 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„',
                'auth/invalid-email': 'Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­',
                'auth/weak-password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)',
                'auth/wrong-password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
                'auth/user-not-found': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
                'auth/too-many-requests': 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹',
                'auth/network-request-failed': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©'
            };
            
            showAlert(messages[error.code] || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + error.message, 'danger');
        }

        // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ==========
        async function saveSchool() {
            const name = document.getElementById('schoolName').value.trim();
            const code = document.getElementById('schoolCode').value.trim();
            const province = document.getElementById('province').value;
            
            if (!name || !code || !province) {
                showAlert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©', 'danger');
                return;
            }
            
            try {
                showLoading();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                const schoolCheck = await db.collection('schools').doc(code).get();
                if (schoolCheck.exists) {
                    showAlert('Ø±Ù‚Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø¢Ø®Ø±', 'danger');
                    hideLoading();
                    return;
                }
                
                currentSchool = {
                    name: name,
                    code: code,
                    province: province,
                    adminId: currentUser.uid,
                    adminEmail: currentUser.email,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙÙŠ Firestore
                await db.collection('schools').doc(code).set(currentSchool);
                
                // Ø±Ø¨Ø· Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await db.collection('users').doc(currentUser.uid).update({
                    schoolCode: code,
                    schoolName: name,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('schoolInfoSection').classList.add('hidden');
                document.getElementById('uploadSection').classList.remove('hidden');
                
                showAlert('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Save school error:', error);
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        // ========== Ø¯ÙˆØ§Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ==========
        async function loadFiles() {
            const studentsFile = document.getElementById('studentsFile').files[0];
            const teachersFile = document.getElementById('teachersFile').files[0];
            
            if (!studentsFile || !teachersFile) {
                showAlert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙÙŠÙ† Ù…Ø¹Ø§Ù‹', 'warning');
                return;
            }
            
            try {
                showLoading();
                document.getElementById('uploadProgress').classList.remove('hidden');
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°
                updateProgress(30, 'Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°...');
                students = await readExcelFile(studentsFile, 'students');
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
                updateProgress(60, 'Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©...');
                teachers = await readExcelFile(teachersFile, 'teachers');
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase
                updateProgress(80, 'Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...');
                await saveDataToFirebase();
                
                updateProgress(100, 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                
                setTimeout(() => {
                    document.getElementById('uploadSection').classList.add('hidden');
                    initializeSystem();
                    showAlert('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Load files error:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        async function readExcelFile(file, type) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // ØªÙ†Ø¸ÙŠÙ ÙˆØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        const cleanedData = cleanExcelData(jsonData, type);
                        resolve(cleanedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function cleanExcelData(data, type) {
            const cleaned = data.map((item, index) => {
                const obj = { id: index + 1 };
                
                if (type === 'students') {
                    obj.lastName = item['Ø§Ù„Ù„Ù‚Ø¨'] || item['lastName'] || '';
                    obj.firstName = item['Ø§Ù„Ø¥Ø³Ù…'] || item['firstName'] || '';
                    obj.class = item['Ø§Ù„Ù‚Ø³Ù…'] || item['class'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    obj.birthDate = item['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯'] || item['birthDate'] || '';
                    obj.gender = item['Ø§Ù„Ø¬Ù†Ø³'] || item['gender'] || '';
                    obj.parentPhone = item['Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±'] || item['parentPhone'] || '';
                } else if (type === 'teachers') {
                    obj.fullName = item['Ø§Ù„Ø¥Ø³Ù…'] || item['fullName'] || '';
                    obj.subject = item['Ø§Ù„Ù…Ø§Ø¯Ø©'] || item['subject'] || '';
                    obj.email = item['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'] || item['email'] || '';
                    obj.phone = item['Ø§Ù„Ù‡Ø§ØªÙ'] || item['phone'] || '';
                    obj.hireDate = item['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†'] || item['hireDate'] || '';
                }
                
                return obj;
            }).filter(item => {
                // ØªØµÙÙŠØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
                if (type === 'students') {
                    return item.firstName && item.lastName;
                } else {
                    return item.fullName;
                }
            });
            
            console.log(`${type} cleaned data:`, cleaned);
            return cleaned;
        }

        async function saveDataToFirebase() {
            if (!currentSchool) {
                throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø³Ø© Ù…Ø­Ø¯Ø¯Ø©');
            }
            
            try {
                const batch = db.batch();
                const schoolRef = db.collection('schools').doc(currentSchool.code);
                
                // Ø­ÙØ¸ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°
                students.forEach(student => {
                    const studentRef = schoolRef.collection('students').doc(student.id.toString());
                    batch.set(studentRef, {
                        ...student,
                        schoolCode: currentSchool.code,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                // Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
                teachers.forEach(teacher => {
                    const teacherRef = schoolRef.collection('teachers').doc(teacher.id.toString());
                    batch.set(teacherRef, {
                        ...teacher,
                        schoolCode: currentSchool.code,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                batch.update(schoolRef, {
                    totalStudents: students.length,
                    totalTeachers: teachers.length,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await batch.commit();
                console.log('âœ… Data saved to Firebase successfully');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                throw error;
            }
        }

        // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ==========
        async function initializeSystem() {
            try {
                // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('schoolInfoSection').classList.add('hidden');
                document.getElementById('uploadSection').classList.add('hidden');
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                document.getElementById('mainSystem').classList.remove('hidden');
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const email = currentUser.email;
                const username = email.split('@')[0];
                document.getElementById('userName').textContent = username;
                
                // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                if (userRole === 'admin') {
                    document.getElementById('adminTab').classList.remove('hidden');
                }
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await loadDashboardData();
                await loadStudents();
                await loadTeachers();
                await loadClasses();
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('attendanceDate').value = today;
                
                console.log('âœ… System initialized successfully');
            } catch (error) {
                console.error('Error initializing system:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: ' + error.message, 'danger');
            }
        }

        function showSection(sectionId) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            const sections = ['dashboardSection', 'studentsSection', 'teachersSection', 
                            'attendanceSection', 'reportsSection', 'adminSection'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            document.getElementById(sectionId).classList.remove('hidden');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ========== Ø¯ÙˆØ§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ==========
        async function loadDashboardData() {
            try {
                if (!currentSchool) return;
                
                // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°
                const studentsSnapshot = await db.collection('schools').doc(currentSchool.code)
                    .collection('students').get();
                document.getElementById('totalStudents').textContent = studentsSnapshot.size;
                
                // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
                const teachersSnapshot = await db.collection('schools').doc(currentSchool.code)
                    .collection('teachers').get();
                document.getElementById('totalTeachers').textContent = teachersSnapshot.size;
                
                // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
                const usersSnapshot = await db.collection('users')
                    .where('schoolCode', '==', currentSchool.code).get();
                document.getElementById('activeUsers').textContent = usersSnapshot.size;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª
                updateCharts(studentsSnapshot);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', error);
            }
        }

        function updateCharts(studentsSnapshot) {
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ° Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            const classDistribution = {};
            studentsSnapshot.forEach(doc => {
                const student = doc.data();
                const className = student.class || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                classDistribution[className] = (classDistribution[className] || 0) + 1;
            });
            
            // Ø±Ø³Ù… Ù…Ø®Ø·Ø· Ø§Ù„ØªÙˆØ²ÙŠØ¹
            const ctx1 = document.getElementById('studentsChart');
            if (!ctx1) return;
            
            if (window.studentsChart) {
                window.studentsChart.destroy();
            }
            
            window.studentsChart = new Chart(ctx1.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: Object.keys(classDistribution),
                    datasets: [{
                        data: Object.values(classDistribution),
                        backgroundColor: [
                            '#006233', '#2E7D32', '#4CAF50', '#81C784',
                            '#FF9800', '#FF5722', '#2196F3', '#9C27B0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: true
                        }
                    }
                }
            });
            
            // Ø±Ø³Ù… Ù…Ø®Ø·Ø· Ø§Ù„ØºÙŠØ§Ø¨ (Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„ØªÙˆØ¶ÙŠØ­)
            const ctx2 = document.getElementById('attendanceChart');
            if (!ctx2) return;
            
            if (window.attendanceChart) {
                window.attendanceChart.destroy();
            }
            
            const attendanceData = Object.keys(classDistribution).map(() => 
                Math.floor(Math.random() * 20) // Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ©
            );
            
            window.attendanceChart = new Chart(ctx2.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(classDistribution),
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª',
                        data: attendanceData,
                        backgroundColor: '#FF5722'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ° ==========
        async function loadStudents() {
            try {
                if (!currentSchool) return;
                
                const studentsRef = db.collection('schools').doc(currentSchool.code)
                    .collection('students');
                
                const snapshot = await studentsRef.get();
                students = [];
                snapshot.forEach(doc => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                
                displayStudents();
                populateClassFilter();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°:', error);
            }
        }

        function displayStudents() {
            const searchTerm = document.getElementById('studentSearch')?.value.toLowerCase() || '';
            const classFilter = document.getElementById('classFilter')?.value || '';
            
            let filteredStudents = students;
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
            if (searchTerm) {
                filteredStudents = filteredStudents.filter(s =>
                    (s.firstName && s.firstName.toLowerCase().includes(searchTerm)) ||
                    (s.lastName && s.lastName.toLowerCase().includes(searchTerm)) ||
                    ((s.firstName + ' ' + s.lastName).toLowerCase().includes(searchTerm))
                );
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
            if (classFilter) {
                filteredStudents = filteredStudents.filter(s => s.class === classFilter);
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­ÙŠ
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const paginatedStudents = filteredStudents.slice(startIndex, endIndex);
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const tbody = document.getElementById('studentsTable');
            if (!tbody) return;
            
            let html = '';
            
            if (paginatedStudents.length === 0) {
                html = `<tr><td colspan="8"><div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div></td></tr>`;
            } else {
                paginatedStudents.forEach((student, index) => {
                    const globalIndex = startIndex + index + 1;
                    html += `
                        <tr>
                            <td>${globalIndex}</td>
                            <td>${student.id}</td>
                            <td>${student.lastName || ''}</td>
                            <td>${student.firstName || ''}</td>
                            <td><span class="badge badge-success">${student.class || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></td>
                            <td>${student.birthDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td>
                                <span class="badge badge-warning">${Math.floor(Math.random() * 10)}%</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewStudent('${student.id}')">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                <button class="btn btn-sm btn-warning" onclick="editStudent('${student.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tbody.innerHTML = html;
            
            // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­ÙŠ
            updatePagination(filteredStudents.length);
        }

        function populateClassFilter() {
            const classFilter = document.getElementById('classFilter');
            if (!classFilter) return;
            
            const uniqueClasses = [...new Set(students.map(s => s.class))].filter(c => c);
            
            let options = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>';
            uniqueClasses.forEach(className => {
                options += `<option value="${className}">${className}</option>`;
            });
            
            classFilter.innerHTML = options;
        }

        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / pageSize);
            
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            const totalPages = Math.ceil(students.length / pageSize);
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayStudents();
            }
        }

        // ========== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('loginAlert');
            if (!alertDiv) return;
            
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.classList.remove('hidden');
            
            setTimeout(() => {
                alertDiv.classList.add('hidden');
            }, 5000);
        }

        function showLoading() {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© spinner Ù‡Ù†Ø§
            console.log('Loading...');
        }

        function hideLoading() {
            console.log('Loading finished');
        }

        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (progressBar) progressBar.style.width = percent + '%';
            if (progressText) progressText.textContent = text;
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ==========
        function downloadTemplate() {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨ Excel Ù„Ù„ØªÙ„Ø§Ù…ÙŠØ°
            const studentTemplate = [
                { Ø§Ù„Ù„Ù‚Ø¨: 'Ø§Ù„Ø¹Ø¨Ø³ÙŠ', Ø§Ù„Ø¥Ø³Ù…: 'Ø£Ø­Ù…Ø¯', Ø§Ù„Ù‚Ø³Ù…: 'Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯': '2015-01-15', Ø§Ù„Ø¬Ù†Ø³: 'Ø°ÙƒØ±', 'Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±': '0551234567' },
                { Ø§Ù„Ù„Ù‚Ø¨: 'Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ', Ø§Ù„Ø¥Ø³Ù…: 'ÙØ§Ø·Ù…Ø©', Ø§Ù„Ù‚Ø³Ù…: 'Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯': '2015-03-20', Ø§Ù„Ø¬Ù†Ø³: 'Ø£Ù†Ø«Ù‰', 'Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±': '0557654321' }
            ];
            
            const ws = XLSX.utils.json_to_sheet(studentTemplate);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°");
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
            XLSX.writeFile(wb, "Ù‚Ø§Ù„Ø¨_Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°.xlsx");
            
            showAlert('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // ========== ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Document loaded, initializing...');
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
            const studentSearch = document.getElementById('studentSearch');
            if (studentSearch) {
                studentSearch.addEventListener('input', displayStudents);
            }
            
            const classFilter = document.getElementById('classFilter');
            if (classFilter) {
                classFilter.addEventListener('change', displayStudents);
            }
            
            const pageSizeSelect = document.getElementById('pageSize');
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', function() {
                    pageSize = parseInt(this.value);
                    currentPage = 1;
                    displayStudents();
                });
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User is signed in:', user.email);
                    currentUser = user;
                    
                    try {
                        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            userRole = userData.role;
                            
                            if (userData.schoolCode) {
                                const schoolDoc = await db.collection('schools').doc(userData.schoolCode).get();
                                if (schoolDoc.exists) {
                                    currentSchool = schoolDoc.data();
                                    document.getElementById('loginSection').classList.add('hidden');
                                    await initializeSystem();
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error checking auth state:', error);
                    }
                } else {
                    console.log('User is signed out');
                    currentUser = null;
                    userRole = null;
                    currentSchool = null;
                }
            });
        });

        // ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ ==========
        async function exportStudents() {
            if (!students.length) {
                showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(students.map(s => ({
                'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ': s.id,
                'Ø§Ù„Ù„Ù‚Ø¨': s.lastName,
                'Ø§Ù„Ø¥Ø³Ù…': s.firstName,
                'Ø§Ù„Ù‚Ø³Ù…': s.class,
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯': s.birthDate,
                'Ø§Ù„Ø¬Ù†Ø³': s.gender,
                'Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±': s.parentPhone
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°");
            XLSX.writeFile(wb, `ØªÙ„Ø§Ù…ÙŠØ°_${currentSchool?.code || 'data'}_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showAlert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function showAddStudentModal() {
            Swal.fire({
                title: 'Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù…ÙŠØ° Ø¬Ø¯ÙŠØ¯',
                html: `
                    <input type="text" id="swal-lastName" class="swal2-input" placeholder="Ø§Ù„Ù„Ù‚Ø¨">
                    <input type="text" id="swal-firstName" class="swal2-input" placeholder="Ø§Ù„Ø¥Ø³Ù…">
                    <input type="text" id="swal-class" class="swal2-input" placeholder="Ø§Ù„Ù‚Ø³Ù…">
                    <input type="date" id="swal-birthDate" class="swal2-input" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯">
                `,
                confirmButtonText: 'Ø­ÙØ¸',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                showCancelButton: true,
                preConfirm: () => {
                    return {
                        lastName: document.getElementById('swal-lastName').value,
                        firstName: document.getElementById('swal-firstName').value,
                        class: document.getElementById('swal-class').value,
                        birthDate: document.getElementById('swal-birthDate').value
                    };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù…ÙŠØ° Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    const newStudent = {
                        ...result.value,
                        id: students.length + 1,
                        schoolCode: currentSchool.code,
                        createdAt: new Date().toISOString()
                    };
                    
                    await db.collection('schools').doc(currentSchool.code)
                        .collection('students').doc(newStudent.id.toString()).set(newStudent);
                    
                    showAlert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ„Ù…ÙŠØ° Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    await loadStudents();
                }
            });
        }

        // ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ==========
        async function loadTeachers() {
            try {
                if (!currentSchool) return;
                
                const teachersRef = db.collection('schools').doc(currentSchool.code)
                    .collection('teachers');
                
                const snapshot = await teachersRef.get();
                const tbody = document.getElementById('teachersTable');
                if (!tbody) return;
                
                let html = '';
                
                if (snapshot.empty) {
                    html = '<tr><td colspan="8"><div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div></td></tr>';
                } else {
                    let index = 1;
                    snapshot.forEach(doc => {
                        const teacher = doc.data();
                        html += `
                            <tr>
                                <td>${index++}</td>
                                <td>${teacher.fullName || ''}</td>
                                <td>${teacher.subject || ''}</td>
                                <td>${teacher.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                <td>${teacher.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                <td>${teacher.hireDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                <td><span class="badge badge-success">Ù†Ø´Ø·</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                    <button class="btn btn-sm btn-warning">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                tbody.innerHTML = html;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©:', error);
            }
        }

        async function loadClasses() {
            if (!students.length) return;
            
            const uniqueClasses = [...new Set(students.map(s => s.class))].filter(c => c);
            const select = document.getElementById('attendanceClass');
            if (!select) return;
            
            let options = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
            uniqueClasses.forEach(className => {
                options += `<option value="${className}">${className}</option>`;
            });
            
            select.innerHTML = options;
        }

        // ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ==========
        function logout() {
            auth.signOut().then(() => {
                window.location.reload();
            });
        }

        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
        document.addEventListener('DOMContentLoaded', function() {
            const header = document.querySelector('.header');
            if (!header) return;
            
            const logoutBtn = document.createElement('button');
            logoutBtn.innerHTML = 'ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬';
            logoutBtn.style.cssText = `
                position: absolute;
                left: 20px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-family: 'Cairo', sans-serif;
            `;
            logoutBtn.onclick = logout;
            header.appendChild(logoutBtn);
        });

        // Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØµØ­ÙŠØ­
        function viewStudent(id) {
            Swal.fire({
                title: 'Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„Ù…ÙŠØ°',
                text: `Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„Ù…ÙŠØ°: ${id}`,
                icon: 'info'
            });
        }

        function editStudent(id) {
            Swal.fire({
                title: 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„Ù…ÙŠØ°',
                text: `Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„Ù…ÙŠØ°: ${id}`,
                icon: 'warning'
            });
        }

        function deleteStudent(id) {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„ØªÙ„Ù…ÙŠØ°!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°ÙÙ‡!',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await db.collection('schools').doc(currentSchool.code)
                            .collection('students').doc(id.toString()).delete();
                        showAlert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ„Ù…ÙŠØ° Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        await loadStudents();
                    } catch (error) {
                        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªÙ„Ù…ÙŠØ°', 'danger');
                    }
                }
            });
        }

    </script>
</body>
</html>


